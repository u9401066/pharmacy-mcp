# Architecture

## 概述

藥品資訊 MCP Server 採用分層架構（DDD），將藥品領域邏輯與基礎設施分離。

## 架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                     MCP Client (Claude)                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Presentation Layer                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────────┐ │
│  │ Search Tools│ │ Info Tools  │ │Dosage Tools │ │Interaction │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Application Layer                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────────┐ │
│  │SearchService│ │ InfoService │ │DosageCalc   │ │Interaction │ │
│  │             │ │             │ │             │ │Checker     │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Domain Layer                                │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐  │
│  │        Entities         │  │      Value Objects          │  │
│  │ - Drug                  │  │ - Dosage                    │  │
│  │ - Interaction           │  │ - Severity                  │  │
│  │ - DrugClass             │  │ - InteractionType           │  │
│  └─────────────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────────┐ │
│  │RxNorm Client│ │ FDA Client  │ │DailyMed     │ │   Cache    │ │
│  │             │ │             │ │Client       │ │            │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      External APIs                               │
│  ┌──────────┐ ┌────────────┐ ┌───────────┐ ┌─────────────────┐ │
│  │ RxNorm   │ │  openFDA   │ │ DailyMed  │ │    RxClass      │ │
│  └──────────┘ └────────────┘ └───────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 分層說明

### 1. Presentation Layer (`presentation/`)
MCP Tool 定義層，負責：
- 定義 Tool 參數和回傳格式
- 輸入驗證
- 格式化輸出（附帶免責聲明）

### 2. Application Layer (`application/`)
應用服務層，負責：
- 組合多個 Domain 服務
- 實現用例（Use Cases）
- 協調 Infrastructure 呼叫

### 3. Domain Layer (`domain/`)
核心領域層，負責：
- 定義藥品實體（Drug, Interaction）
- 定義值物件（Dosage, Severity）
- 純業務邏輯，無外部依賴

### 4. Infrastructure Layer (`infrastructure/`)
基礎設施層，負責：
- 外部 API 客戶端
- 快取管理
- 資料轉換

## 資料流

```
User Request
    │
    ▼
MCP Tool (Presentation)
    │
    ▼
Application Service
    │
    ├── Domain Logic
    │
    └── Infrastructure (API Call)
            │
            ▼
        External API
            │
            ▼
        Cache (Optional)
            │
            ▼
        Response
```

## 快取策略

| 資料類型 | TTL | 說明 |
|----------|-----|------|
| Drug Info | 24h | 藥品基本資訊穩定 |
| Interactions | 24h | 交互作用資訊穩定 |
| Search Results | 1h | 搜尋結果可能變動 |
| Labels | 7d | FDA 標籤較少更新 |

---

*Updated: 2025-12-22*
